<DOCTYPE html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
        <script src="http://code.jquery.com/jquery-latest.js"></script> 
        <script type="text/javascript">
        function Chat(options) {
                var chat = this;

                this.init = function() {
                    var container = $('#container');

                    container.html('');
                    container.append('<div id="websocket-chat"></div>');
                    $('#websocket-chat').append('<pre id="websocket-chat-log" style="height:200px; overflow: auto;"></pre>');
                    $('#websocket-chat').append('<form id="websocket-chat-form"><input id="websocket-chat-input" style="width:90%" /></form>');
                    $('#websocket-chat-form').submit(function() {
                        var message = $('#websocket-chat-input').val().substring(0, 140);
                        $('#websocket-chat-input').val('');
                        if (message && message != '') {
                            chat.send(message);
                        }
                        return false;
                    });
                };

                this.read = function(message) {
                    var log = $('#websocket-chat-log');
                    log.append(message + "\n");
                    log.animate({scrollTop: log[0].scrollHeight});
                };

                this.send = function(message) {
                    chat.onsend(message);
                };
            }

            $(document).ready(function() {
                $('#42').onwebkitspeechchange = function(e) {
                        var ws = new WebSocket("ws:0.0.0.0:3001");
                        ws.send(e);
                };
            }

            $(document).ready(function() {
                $('#container').html('Connecting...');

                var ws = new WebSocket("ws:0.0.0.0:3001");

                var chat = new Chat();

                ws.onerror = function(e) {
                    $('#container').html('Error: ' + e);
                };

                ws.onopen = function() {
                    $('#container').html('Connected!');

                    chat.init();
                    chat.onsend = function(message) {
                        ws.send(message);
                    };
                };

                ws.onmessage = function(e) {
                    chat.read(e.data);
                };

                ws.onclose = function() {
                    $('#container').html('Disconnected :(');
                };
            });
        </script>

<style>
    /*
div.speech {
position:relative;
}

div.fakespeech {
position:absolute;
top: 0px;
left: 0px;
z-index: 1;
}

input.speechinput {
position: relative;
-moz-opacity:0;
filter:alpha(opacity:0);
opacity: 0;
z-index: 2;
}
*/
</style>
</head>

<body>
    <div id="container" style="border:1px solid #ccc; width:500px"></div>
    <div class='speech'>
        <input  class="speechinput" id=42 x-webkit-speech="">
    </div>
</body>
</html>
